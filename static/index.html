<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIçº³ç•ŒåŠ©ç† - ä»¿è±†åŒ…å¯¹è¯ç‰ˆ</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- å·¦ä¾§ï¼šè®°å¿†/çŸ¥è¯†åº“å¯¼èˆª -->
        <div class="left-sidebar">
            <div class="title">ğŸ“š æˆ‘çš„è®°å¿†ä¸çŸ¥è¯†åº“</div>
            <div class="menu-item active" onclick="loadMemory()">ğŸ” åŠ è½½æˆ‘çš„é•¿æœŸè®°å¿†</div>
            <div class="menu-item" onclick="sendMsg('æå–æˆ‘çš„å…³é”®è®°å¿†')">ğŸ§  æŸ¥çœ‹æˆ‘çš„å…³é”®è®°å¿†</div>
            <div class="menu-item" onclick="sendMsg('æ±‡æ€»æˆ‘çš„æ‰€æœ‰èµ„æ–™')">ğŸ“– æ±‡æ€»æ‰€æœ‰èµ„æ–™</div>
            <div class="menu-item" onclick="sendMsg('åˆ é™¤æ— æ•ˆæ–‡ä»¶')">ğŸ—‘ï¸ æ¸…ç†æ— æ•ˆæ–‡ä»¶</div>
            <div class="menu-item" onclick="sendMsg('æŸ¥æ‰¾æ‰€æœ‰å…³äºç¾é£Ÿçš„èµ„æ–™')">ğŸ² ç¾é£Ÿç›¸å…³èµ„æ–™</div>
            <div class="menu-item" onclick="listFiles()">ğŸ“‚ æŸ¥çœ‹æˆ‘çš„æ–‡ä»¶</div> <!-- æ·»åŠ æŸ¥çœ‹æ–‡ä»¶æŒ‰é’® -->
        </div>

        <!-- ä¸­é—´ï¼šæ ¸å¿ƒå¯¹è¯åŒºåŸŸï¼ˆä»¿è±†åŒ…ï¼‰ -->
        <div class="chat-area">
            <div class="chat-header">AIçº³ç•ŒåŠ©ç† - æ°¸ä¹…è®°å¿† | å…¨æ ¼å¼çŸ¥è¯†åº“ | è‡ªç„¶è¯­è¨€æ“æ§</div>
            <div class="chat-content" id="chat-content">
                <!-- æ¬¢è¿è¯­ -->
                <div class="message ai-message">
                    <div class="avatar">AI</div>
                    <div class="content">
                        ä½ å¥½ï½æˆ‘æ˜¯ä½ çš„ä¸“å±çº³ç•ŒåŠ©ç†ï¼Œå’Œè±†åŒ…ä¸€æ ·å¥½ç”¨å“¦ï¼<br>
                        âœ… å¯ä»¥å‘é€æ–‡å­—/æ—¥è®°/èµ„æ–™ï¼Œæˆ‘ä¼šæ°¸ä¹…ä¿å­˜<br>
                        âœ… å¯ä»¥ä¸Šä¼ å›¾ç‰‡/PDF/Excel/éŸ³è§†é¢‘ï¼Œè‡ªåŠ¨è§£æå†…å®¹<br>
                        âœ… æˆ‘ä¼šè®°ä½ä½ çš„æ‰€æœ‰åå¥½ï¼ˆæ¯”å¦‚çˆ±åƒé±¼ã€ä¸åƒè¾£ï¼‰<br>
                        âœ… æ‰€æœ‰æ“ä½œéƒ½å¯ä»¥ç”¨è‡ªç„¶è¯­è¨€æŒ‡ä»¤å®Œæˆï½
                    </div>
                </div>
            </div>

        <!-- åº•éƒ¨ï¼šè¾“å…¥æ¡†ï¼ˆè±†åŒ…åŒæ¬¾ï¼‰ -->
        <div class="input-area">
            <label for="file-input" class="file-btn"><i class="fas fa-paperclip"></i></label>
            <input type="file" id="file-input" multiple accept="*">
            <textarea id="msg-input" placeholder="è¾“å…¥ä½ çš„é—®é¢˜/æŒ‡ä»¤/èµ„æ–™ï¼Œæ”¯æŒè‡ªç„¶è¯­è¨€æ“æ§ï¼Œæ¯”å¦‚ï¼šæˆ‘çˆ±åƒé±¼ä¸åƒè¾£ã€ä¿å­˜è¿™ä»½æ—¥è®°ã€æŸ¥æ‰¾ä¸Šå‘¨çš„PDF..." spellcheck="false"></textarea>
            <label for="file-input" class="plus-btn"><i class="fas fa-plus"></i></label>
            <button id="send-btn" onclick="sendMsg()">å‘é€</button>
        </div>

        <!-- å³ä¾§ï¼šå¿«æ·æŒ‡ä»¤ -->
        <!-- <div class="right-sidebar">
            <div class="title">âš¡ å¿«æ·æŒ‡ä»¤</div>
            <div class="shortcut" onclick="sendMsg('ä»Šå¤©é€‚åˆåƒä»€ä¹ˆï¼Ÿ')">ä»Šå¤©åƒä»€ä¹ˆï¼Ÿ</div>
            <div class="shortcut" onclick="sendMsg('ä¿å­˜ï¼šæˆ‘çˆ±åƒæ¸…è’¸é±¼ï¼Œä¸åƒè¾£å’Œé¦™èœ')">æ·»åŠ é¥®é£Ÿåå¥½</div>
            <div class="shortcut" onclick="sendMsg('æŸ¥æ‰¾æˆ‘ä¸Šä¼ çš„æ‰€æœ‰PDFæ–‡ä»¶')">æŸ¥æ‰¾PDFæ–‡ä»¶</div>
            <div class="shortcut" onclick="sendMsg('å¸®æˆ‘æ•´ç†ä»Šå¤©çš„æ—¥è®°')">æ•´ç†æ—¥è®°</div>
            <div class="shortcut" onclick="listFiles()">æŸ¥çœ‹æˆ‘çš„æ–‡ä»¶</div> 
        </div> -->
    </div>

    <script>
        // åŠ è½½é•¿æœŸè®°å¿†ï¼ˆé¡µé¢åŠ è½½è‡ªåŠ¨æ‰§è¡Œï¼‰
        window.onload = async () => {
            await loadMemory();
        };

        // åŠ è½½è®°å¿†æ¥å£
        async function loadMemory() {
            try {
                const res = await fetch('/load_memory', { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}
                });
                
                if (!res.ok) {
                    throw new Error(`HTTPé”™è¯¯ï¼çŠ¶æ€ç ï¼š${res.status}`);
                }
                
                const data = await res.json();
                addMsg('ai', data.msg);
            } catch (e) {
                addMsg('ai', `âŒ åŠ è½½è®°å¿†å¤±è´¥ï¼š${e.message}`);
                console.error('åŠ è½½è®°å¿†é”™è¯¯:', e);
            }
        }

        // è·å–æ–‡ä»¶åˆ—è¡¨
        async function listFiles() {
            try {
                const res = await fetch('/list_files', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: 'user_001',
                        page: 1,
                        page_size: 20
                    })
                });
                
                if (!res.ok) {
                    throw new Error(`HTTPé”™è¯¯ï¼çŠ¶æ€ç ï¼š${res.status}`);
                }
                
                const data = await res.json();
                if (data.code === 200) {
                    if (data.data.files.length === 0) {
                        addMsg('ai', 'ğŸ“‚ ä½ è¿˜æ²¡æœ‰ä¸Šä¼ ä»»ä½•æ–‡ä»¶');
                        return;
                    }
                    
                    let filesMsg = 'ğŸ“‚ ä½ çš„æ–‡ä»¶åˆ—è¡¨ï¼š<br>';
                    data.data.files.forEach(file => {
                        filesMsg += `<div style="margin: 5px 0; padding: 5px; background: #f0f0f0; border-radius: 4px;">
                            <a href="/download_file/${file.file_id}" target="_blank" style="color: #1890ff; text-decoration: none;">
                                <i class="fas fa-file-download"></i> ${file.filename}
                            </a><br>
                            <small style="color: #666;">ä¸Šä¼ æ—¶é—´ï¼š${new Date(file.create_time).toLocaleString()}</small>
                        </div>`;
                    });
                    
                    addMsg('ai', filesMsg);
                } else {
                    addMsg('ai', `âŒ è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥ï¼š${data.msg}`);
                }
            } catch (e) {
                addMsg('ai', `âŒ è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥ï¼š${e.message}`);
                console.error('è·å–æ–‡ä»¶åˆ—è¡¨é”™è¯¯:', e);
            }
        }

        // æ·»åŠ æ–‡ä»¶æ‹–æ”¾æ”¯æŒ
        const msgInput = document.getElementById('msg-input');
        const fileInput = document.getElementById('file-input');

        // æ‹–æ”¾äº‹ä»¶å¤„ç†
        msgInput.addEventListener('dragover', (e) => {
            e.preventDefault();
            msgInput.classList.add('drag-over');
        });

        msgInput.addEventListener('dragleave', () => {
            msgInput.classList.remove('drag-over');
        });

        msgInput.addEventListener('drop', (e) => {
            e.preventDefault();
            msgInput.classList.remove('drag-over');
            
            if (e.dataTransfer.files.length > 0) {
                // è®¾ç½®æ‹–æ”¾çš„æ–‡ä»¶åˆ°æ–‡ä»¶è¾“å…¥æ¡†
                fileInput.files = e.dataTransfer.files;
                // æ˜¾ç¤ºå·²é€‰æ‹©æ–‡ä»¶æ•°é‡çš„æç¤º
                const fileCount = e.dataTransfer.files.length;
                addMsg('ai', `ğŸ“ å·²é€‰æ‹© ${fileCount} ä¸ªæ–‡ä»¶ï¼Œè¯·ç‚¹å‡»å‘é€æŒ‰é’®ä¸Šä¼ `);
            }
        });

        // ä¸ºåŠ å·æŒ‰é’®æ·»åŠ æ–‡ä»¶é€‰æ‹©äº‹ä»¶
        const plusBtn = document.querySelector('.plus-btn');
        plusBtn.addEventListener('click', () => {
            fileInput.click();
        });

        // ç›‘å¬æ–‡ä»¶é€‰æ‹©äº‹ä»¶
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                const fileCount = fileInput.files.length;
                addMsg('ai', `ğŸ“ å·²é€‰æ‹© ${fileCount} ä¸ªæ–‡ä»¶ï¼Œè¯·ç‚¹å‡»å‘é€æŒ‰é’®ä¸Šä¼ `);
            }
        });

        // å‘é€æ¶ˆæ¯æ ¸å¿ƒå‡½æ•°
        async function sendMsg(customMsg = '') {
            const msgInput = document.getElementById('msg-input');
            const content = customMsg || msgInput.value.trim();
            const fileInput = document.getElementById('file-input');
            const files = fileInput.files;
            const sendBtn = document.getElementById('send-btn');

            if (!content && files.length === 0) return;

            // ç¦ç”¨å‘é€æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å‘é€ä¸­...';

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°é¡µé¢
            addMsg('user', content + (files.length > 0 ? ` (ä¸Šä¼ äº† ${files.length} ä¸ªæ–‡ä»¶)` : ''));
            msgInput.value = '';
            fileInput.value = '';

            // è°ƒç”¨åç«¯æ¥å£
            try {
                let res, data;
                // å¦‚æœæœ‰æ–‡ä»¶ä¸Šä¼ ï¼Œæ— è®ºæ˜¯å¦æœ‰å†…å®¹ï¼Œéƒ½è°ƒç”¨/save_allæ¥å£
                if (files.length > 0) {
                    // æ„é€ è¡¨å•æ•°æ®ï¼šæ–‡å­—+æ–‡ä»¶
                    const formData = new FormData();
                    formData.append('content', content);
                    for (let i = 0; i < files.length; i++) {
                        formData.append('files', files[i]);
                    }
                    res = await fetch('/save_all', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!res.ok) {
                        throw new Error(`HTTPé”™è¯¯ï¼çŠ¶æ€ç ï¼š${res.status}`);
                    }
                    
                    data = await res.json();
                    
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    addMsg('ai', data.msg);
                    
                    // å¦‚æœä¸Šä¼ äº†æ–‡ä»¶ï¼Œæ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
                    if (data.data && data.data.files && data.data.files.length > 0) {
                        let filesMsg = 'âœ… å·²ä¸Šä¼ æ–‡ä»¶ï¼š<br>';
                        data.data.files.forEach(filename => {
                            filesMsg += `- ${filename}<br>`;
                        });
                        filesMsg += '<br>ğŸ“Œ ä½ å¯ä»¥ç‚¹å‡»å·¦ä¾§"æŸ¥çœ‹æˆ‘çš„æ–‡ä»¶"æ¥ä¸‹è½½è¿™äº›æ–‡ä»¶';
                        addMsg('ai', filesMsg);
                    }
                } else {
                    // åªæœ‰æ–‡å­—å†…å®¹æ—¶ï¼Œè°ƒç”¨/chatæ¥å£
                    res = await fetch('/chat', {
                        method: 'POST',
                        body: JSON.stringify({message: content}),
                        headers: {'Content-Type': 'application/json'}
                    });
                    
                    if (!res.ok) {
                        throw new Error(`HTTPé”™è¯¯ï¼çŠ¶æ€ç ï¼š${res.status}`);
                    }
                    
                    data = await res.json();
                    // /chatæ¥å£è¿”å›çš„æ˜¯ai_replyå­—æ®µ
                    addMsg('ai', data.ai_reply);
                    // æ˜¾ç¤ºå…³é”®è®°å¿†æ ‡ç­¾
                    if (data.your_key_memory && Object.keys(data.your_key_memory).length > 0) {
                        let memoryStr = "ğŸ§  ä½ çš„é•¿æœŸè®°å¿†ï¼š";
                        for (let [k, v] of Object.entries(data.your_key_memory)) {
                            memoryStr += `<span class="memory-tag">${k}ï¼š${v}</span>`;
                        }
                        addMsg('ai', memoryStr);
                    }
                }
            } catch (e) {
                let errorMsg = 'âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•ï¼';
                if (e.message.includes('Failed to fetch')) {
                    errorMsg = 'âŒ æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ';
                } else if (e.message.includes('HTTPé”™è¯¯')) {
                    errorMsg = `âŒ æœåŠ¡å™¨é”™è¯¯ï¼š${e.message}`;
                }
                addMsg('ai', errorMsg);
                console.error('ç½‘ç»œè¯·æ±‚é”™è¯¯:', e);
            } finally {
                // æ¢å¤å‘é€æŒ‰é’®
                sendBtn.disabled = false;
                sendBtn.innerHTML = 'å‘é€';
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°å¯¹è¯åŒº
        function addMsg(type, content) {
            const chatContent = document.getElementById('chat-content');
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${type}-message`;
            msgDiv.innerHTML = `
                <div class="avatar">${type === 'user' ? 'ä½ ' : 'AI'}</div>
                <div class="content">${content.replace(/\n/g, '<br>')}</div>
            `;
            chatContent.appendChild(msgDiv);
            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatContent.scrollTop = chatContent.scrollHeight;
        }

        // å›è½¦å‘é€æ¶ˆæ¯
        document.getElementById('msg-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMsg();
            }
        });
    </script>
</body>
</html>